<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Дневник Питания</title>
    <style>
        :root {
            --primary-color: #20c997; /* Новый основной цвет, как на скриншоте */
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #212529;
            --secondary-text-color: #6c757d;
            --progress-bg-color: #e9ecef;
            --water-color: #0d6efd;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }

        .page { display: none; padding-bottom: 90px; }
        .page.active { display: block; }

        /* --- Шапка --- */
        .header {
            background: var(--card-color);
            padding: 15px;
            padding-top: env(safe-area-inset-top);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .date-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            font-weight: 600;
        }
        .date-selector .arrow {
            font-size: 1.5em;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 5px 10px;
        }

        /* --- Центральный круг калорий --- */
        .calorie-summary {
            background: var(--card-color);
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            text-align: center;
        }
        .calorie-circle-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 15px auto;
        }
        .calorie-circle-svg {
            transform: rotate(-90deg);
            width: 100%; height: 100%;
        }
        .progress-ring-bg { stroke: var(--progress-bg-color); fill: none; stroke-width: 14; }
        .progress-ring-fg {
            stroke: var(--primary-color);
            fill: none;
            stroke-width: 14;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }
        .circle-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .circle-text-remaining { font-size: 2.2em; font-weight: 700; }
        .circle-text-label { font-size: 0.9em; color: var(--secondary-text-color); }
        .calorie-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .detail-item { flex: 1; text-align: center; }
        .detail-item p { margin: 0; font-size: 1.2em; font-weight: 600; }
        .detail-item span { font-size: 0.8em; color: var(--secondary-text-color); }
        .detail-item p.eaten { color: #fd7e14; }
        .detail-item p.burned { color: #0d6efd; }

        /* --- Макронутриенты --- */
        .macros-summary {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin: 15px;
        }
        .macro {
            flex: 1;
            background: var(--card-color);
            border-radius: 12px;
            padding: 15px;
        }
        .macro-header {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            margin-bottom: 10px;
            color: var(--secondary-text-color);
        }
        .macro-header img { width: 16px; height: 16px; margin-right: 8px; }
        .macro-value { font-size: 1.2em; font-weight: 600; margin-bottom: 8px; }
        .progress-bar { background-color: var(--progress-bg-color); height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; border-radius: 3px; transition: width 0.5s; }
        #carbs-progress .progress-bar-fill { background-color: #fd7e14; }
        #protein-progress .progress-bar-fill { background-color: #dc3545; }
        #fat-progress .progress-bar-fill { background-color: #ffc107; }

        /* --- Карточки приемов пищи --- */
        .meal-card {
            display: flex;
            align-items: center;
            background: var(--card-color);
            padding: 15px;
            border-radius: 16px;
            margin: 12px 15px;
            box-shadow: 0 4px 15px rgba(100,100,100,0.06);
        }
        .meal-card .icon { font-size: 1.5em; margin-right: 15px; }
        .meal-card .details { flex-grow: 1; }
        .meal-card .details p { margin: 0; font-weight: 500; }
        .meal-card .details span { font-size: 0.85em; color: var(--secondary-text-color); }

        /* --- Нижняя навигация и FAB --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            display: flex;
            justify-content: space-around;
            background-color: var(--card-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            height: 60px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: var(--secondary-text-color); cursor: pointer; padding-top: 10px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; }
        .nav-item div { font-size: 0.7em; }
        .fab {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 64px; height: 64px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2.5em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1001;
            border: 4px solid var(--background-color);
        }

        /* --- Модальное окно --- */
        .modal {
            display: none; position: fixed; z-index: 1001;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            flex-direction: column; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* Остальные стили модального окна остаются прежними */
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        .modal-header .close-btn { font-size: 2em; cursor: pointer; border: none; background: none; }
        .modal-content { padding: 0 15px; overflow-y: auto; flex-grow: 1; }
        input, select {
            width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #e0e0e0;
            border-radius: 10px; font-size: 1em; box-sizing: border-box; background: #fff;
        }
        button.primary {
            background-color: var(--primary-color); color: white; padding: 15px;
            border: none; border-radius: 12px; cursor: pointer; width: 100%;
            font-size: 1.1em; font-weight: 600;
        }
        .file-upload-wrapper {
            position: relative; overflow: hidden; display: inline-block;
            width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 10px;
            background: var(--primary-color); color: white; text-align: center; cursor: pointer;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        #search-results button { background-color: #f0f0f0; color: #333; margin-bottom: 5px; text-align: left; }
    </style>
</head>
<body>

    <!-- PAGE 1: Дневник -->
    <div id="diaryPage" class="page active">
        <div class="header">
            <div class="date-selector">
                <span class="arrow" onclick="changeDate(-1)">&lt;</span>
                <span id="current-date"></span>
                <span class="arrow" onclick="changeDate(1)">&gt;</span>
            </div>
        </div>
        
        <div id="diary-content">
            <!-- Контент генерируется JS -->
        </div>
    </div>

    <!-- PAGE 2: Больше/Настройки -->
    <div id="settingsPage" class="page">
        <div style="padding: 15px;">
            <h2>Настройки</h2>
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">Цели по калориям и БЖУ</p>
                <input type="number" id="goal-calories-input" placeholder="Цель калорий (ккал)">
                <input type="number" id="goal-carbs-input" placeholder="Цель углеводы (г)">
                <input type="number" id="goal-protein-input" placeholder="Цель белки (г)">
                <input type="number" id="goal-fat-input" placeholder="Цель жиры (г)">
                <input type="number" id="goal-water-input" placeholder="Цель воды (мл)">
            </div>
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">API Edamam (Поиск по названию)</p>
                <input type="text" id="edamam-id-input" placeholder="Edamam Application ID">
                <input type="text" id="edamam-key-input" placeholder="Edamam Application Key">
            </div>
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">API Spoonacular (Распознавание по фото)</p>
                <input type="text" id="food-api-key-input" placeholder="Spoonacular API ключ">
            </div>
            <button class="primary" onclick="saveSettings()">Сохранить</button>
        </div>
    </div>
    
    <!-- Нижняя навигация и FAB -->
    <div class="fab" onclick="openModal()">+</div>
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('diaryPage')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M20 3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 17H4v-5h4v5zm6 0h-4v-5h4v5zm6 0h-4v-5h4v5zM8 10H4V5h4v5zm6 0h-4V5h4v5zm6 0h-4V5h4v5z"/></svg>
            <div>Дневник</div>
        </div>
        <div class="nav-item" style="flex: 0.5;"></div> <!-- Пустое место для FAB -->
        <div class="nav-item" onclick="showPage('settingsPage')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            <div>Больше</div>
        </div>
    </div>
    
    <!-- Модальное окно -->
    <div id="addFoodModal" class="modal">
        <div class="modal-header">
            <h2>Добавить запись</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-content">
            <select id="meal-type-select">
                <option value="breakfast">Завтрак</option>
                <option value="lunch">Обед</option>
                <option value="dinner">Ужин</option>
                <option value="snacks">Перекус</option>
            </select>
            <hr>
            <div class="file-upload-wrapper">
                <span>📷 Распознать еду по фото</span>
                <input type="file" id="photo-upload" accept="image/*" onchange="recognizeFoodByImage(this)">
            </div>
            <p style="text-align:center; color: var(--secondary-text-color); margin: 15px;">- или -</p>
            <input type="search" id="search-food-input" placeholder="Поиск продукта по названию...">
            <button class="primary" onclick="searchFoodByText()">Найти</button>
            <div id="search-results" style="margin: 15px 0;"></div>
            <hr>
            <input type="text" id="manual-name" placeholder="Название">
            <input type="number" id="manual-calories" placeholder="Калории">
            <input type="number" id="manual-protein" placeholder="Белки (г)">
            <input type="number" id="manual-fat" placeholder="Жиры (г)">
            <input type="number" id="manual-carbs" placeholder="Углеводы (г)">
            <button class="primary" onclick="addFoodEntry()">Добавить</button>
        </div>
    </div>
    
    <script>
        let selectedDate = new Date();

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            changeDate(0); // Инициализация с сегодняшней датой
            showPage('diaryPage');
        });

        // --- Навигация и даты ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const activeNavItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick') === `showPage('${pageId}')`);
            if(activeNavItem) activeNavItem.classList.add('active');
        }

        function changeDate(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            const today = new Date();
            const isToday = selectedDate.toDateString() === today.toDateString();
            document.getElementById('current-date').textContent = isToday ? 'Сегодня' : selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            renderDiary();
        }

        // --- Рендеринг (Отрисовка интерфейса) ---
        function renderDiary() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            const settings = loadSettings();
            
            const content = document.getElementById('diary-content');
            content.innerHTML = `
                <!-- Карточка Воды -->
                <div class="meal-card" style="background: linear-gradient(90deg, #3a95f7, #64b5f6); color: white;">
                     <div class="icon" style="background: rgba(255,255,255,0.2);">💧</div>
                     <div class="details">
                         <p style="font-weight: 600;">Напитки</p>
                         <span>${data.water || 0} мл</span>
                     </div>
                     <button class="action-btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="addWater()">+</button>
                </div>

                <!-- Сводка по калориям -->
                <div class="calorie-summary" id="calorie-summary"></div>
                
                <!-- Макронутриенты -->
                <div class="macros-summary" id="macros-summary"></div>

                <!-- Приемы пищи -->
                ${createMealCard('breakfast', 'Завтрак', '🍞', data.food || [])}
                ${createMealCard('lunch', 'Обед', '🍲', data.food || [])}
                ${createMealCard('dinner', 'Ужин', '🌙', data.food || [])}
                ${createMealCard('snacks', 'Перекус', '🍏', data.food || [])}
                <div class="meal-card" onclick="addActivity()">
                    <div class="icon" style="background: #fff5e6">🔥</div>
                    <div class="details">
                        <p>Сожжено калорий</p>
                        <span>${data.activity || 0} ккал</span>
                    </div>
                </div>
            `;
            updateSummary();
        }

        function updateSummary() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            const settings = loadSettings();
            
            const food = data.food || [];
            const eaten = food.reduce((sum, item) => sum + item.calories, 0);
            const burned = data.activity || 0;
            const remaining = settings.goalCalories - eaten + burned;

            const totalCarbs = food.reduce((sum, item) => sum + item.carbs, 0);
            const totalProtein = food.reduce((sum, item) => sum + item.protein, 0);
            const totalFat = food.reduce((sum, item) => sum + item.fat, 0);

            // Обновляем круг калорий
            const summaryContainer = document.getElementById('calorie-summary');
            const progress = eaten / settings.goalCalories;
            const radius = 83;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.min(progress, 1) * circumference);

            summaryContainer.innerHTML = `
                <div style="text-align: left; font-size: 0.9em; color: var(--secondary-text-color);">Цель: ${settings.goalCalories} ккал</div>
                <div class="calorie-circle-container">
                    <svg class="calorie-circle-svg">
                        <circle class="progress-ring-bg" cx="90" cy="90" r="${radius}"></circle>
                        <circle class="progress-ring-fg" cx="90" cy="90" r="${radius}" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
                    </svg>
                    <div class="circle-text">
                        <div class="circle-text-remaining">${remaining.toFixed(0)}</div>
                        <div class="circle-text-label">Осталось ккал</div>
                    </div>
                </div>
                <div class="calorie-details">
                    <div class="detail-item"><p class="eaten">${eaten.toFixed(0)}</p><span>Еда и напитки</span></div>
                    <div class="detail-item"><p class="burned">${burned.toFixed(0)}</p><span>Сожжено</span></div>
                </div>
            `;
            
            // Обновляем макросы
            const macrosContainer = document.getElementById('macros-summary');
            macrosContainer.innerHTML = `
                <div class="macro" id="carbs-progress">
                    <div class="macro-header"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fd7e14' d='M20 4H4v2h16V4zm0 3H4v2h16V7zm-2 3H6v2h12v-2zm-2 3h-8v2h8v-2z'/%3E%3C/svg%3E"> Углеводы</div>
                    <div class="macro-value">${totalCarbs.toFixed(0)} г</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalCarbs / settings.goalCarbs) * 100)}%;"></div></div>
                </div>
                <div class="macro" id="protein-progress">
                    <div class="macro-header"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23dc3545' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3C/svg%3E"> Белки</div>
                    <div class="macro-value">${totalProtein.toFixed(0)} г</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalProtein / settings.goalProtein) * 100)}%;"></div></div>
                </div>
                <div class="macro" id="fat-progress">
                    <div class="macro-header"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ffc107' d='M12 22C6.48 22 2 17.52 2 12S6.48 2 12 2s10 4.48 10 10-4.48 10-10 10z'/%3E%3C/svg%3E"> Жиры</div>
                    <div class="macro-value">${totalFat.toFixed(0)} г</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalFat / settings.goalFat) * 100)}%;"></div></div>
                </div>
            `;
        }

        function createMealCard(type, name, icon, foodList) {
            const mealItems = foodList.filter(f => f.mealType === type);
            const totalCalories = mealItems.reduce((sum, item) => sum + item.calories, 0);
            let foodHtml = mealItems.map(item => `<div onclick="event.stopPropagation(); removeFood('${item.id}')">${item.name} - ${item.calories.toFixed(0)} ккал</div>`).join('');
            
            return `
            <div class="meal-card">
                <div class="icon">${icon}</div>
                <div class="details">
                    <p>${name}</p>
                    <span id="${type}-details">${totalCalories.toFixed(0)} ккал</span>
                    <div style="font-size: 0.8em; margin-top: 5px; color: #555;">${foodHtml || ''}</div>
                </div>
            </div>`;
        }
        
        // --- Работа с данными и API ---
        function loadDataForDate(dateKey) { return JSON.parse(localStorage.getItem(dateKey) || '{}'); }
        function saveDataForDate(dateKey, data) { localStorage.setItem(dateKey, JSON.stringify(data)); }
        function saveSettings() { /* ... код без изменений ... */ }
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            const defaults = { goalCalories: 2000, goalCarbs: 250, goalProtein: 150, goalFat: 70, goalWater: 2500, edamamId: '', edamamKey: '', foodApiKey: '' };
            const finalSettings = { ...defaults, ...settings };

            document.getElementById('goal-calories-input').value = finalSettings.goalCalories;
            document.getElementById('goal-carbs-input').value = finalSettings.goalCarbs;
            document.getElementById('goal-protein-input').value = finalSettings.goalProtein;
            document.getElementById('goal-fat-input').value = finalSettings.goalFat;
            document.getElementById('goal-water-input').value = finalSettings.goalWater;
            document.getElementById('edamam-id-input').value = finalSettings.edamamId;
            document.getElementById('edamam-key-input').value = finalSettings.edamamKey;
            document.getElementById('food-api-key-input').value = finalSettings.foodApiKey;
            
            return finalSettings;
        }

        function openModal() { document.getElementById('addFoodModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('addFoodModal').style.display = 'none'; }
        
        async function translateText(text) {
            if (!text || !/[a-zA-Z]/.test(text)) return text; // Не переводим, если нет английских букв
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ru`);
                const data = await response.json();
                if (data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
                return text;
            } catch (error) {
                console.error("Translation error:", error);
                return text; // В случае ошибки возвращаем оригинал
            }
        }
        
        async function searchFoodByText() {
            const query = document.getElementById('search-food-input').value;
            const settings = loadSettings();
            if (!settings.edamamId || !settings.edamamKey) { alert('Введите API ключи Edamam в настройках'); return; }
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = 'Поиск...';
            const url = `https://api.edamam.com/api/food-database/v2/parser?app_id=${settings.edamamId}&app_key=${settings.edamamKey}&ingr=${encodeURIComponent(query)}&nutrition-type=logging`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                resultsDiv.innerHTML = '';
                for (const item of data.hints.slice(0, 5)) {
                    const food = item.food;
                    const nutrients = food.nutrients;
                    const translatedName = await translateText(food.label);
                    const foodData = { name: translatedName, calories: nutrients.ENERC_KCAL || 0, protein: nutrients.PROCNT || 0, fat: nutrients.FAT || 0, carbs: nutrients.CHOCDF || 0 };
                    resultsDiv.innerHTML += `<button class="primary" onclick='selectFood(${JSON.stringify(foodData)})'>${translatedName} (${(nutrients.ENERC_KCAL || 0).toFixed(0)} ккал)</button>`;
                }
            } catch (error) { resultsDiv.innerHTML = 'Ошибка поиска.'; }
        }
        
        async function recognizeFoodByImage(input) { /* ... код без изменений ... */ }

        function selectFood(data) { /* ... код без изменений ... */ }
        
        function addFoodEntry() { /* ... код без изменений ... */ }
        
        function removeFood(id) { /* ... код без изменений ... */ }
        
        function addWater() {
            const amount = parseInt(prompt("Сколько мл вы выпили?", "250"));
            if (amount && !isNaN(amount)) {
                const dateKey = selectedDate.toISOString().split('T')[0];
                const data = loadDataForDate(dateKey);
                data.water = (data.water || 0) + amount;
                saveDataForDate(dateKey, data);
                renderDiary();
            }
        }
        
        function addActivity() {
            const calories = parseInt(prompt('Введите количество сожженных калорий:'));
            if (calories && !isNaN(calories)) {
                const dateKey = selectedDate.toISOString().split('T')[0];
                const data = loadDataForDate(dateKey);
                data.activity = (data.activity || 0) + calories;
                saveDataForDate(dateKey, data);
                renderDiary();
            }
        }
        // ВАЖНО: Весь остальной JS-код из предыдущего ответа (который не изменен здесь) должен быть скопирован сюда.
        // Я сократил код для краткости, но вам нужно будет взять полный JS-блок из предыдущих ответов и просто заменить/добавить эти новые функции.
        // Например, функции saveSettings, recognizeFoodByImage, selectFood, addFoodEntry, removeFood.
    </script>
    <!-- Вставьте сюда ПОЛНЫЙ СКРИПТ из моего предыдущего ответа, а затем примените изменения, указанные выше -->
    <script>
        // СКОПИРУЙТЕ СЮДА ПОЛНЫЙ JS КОД ИЗ ПРЕДЫДУЩЕГО ОТВЕТА
        // И ВНЕСИТЕ В НЕГО ИЗМЕНЕНИЯ, КОТОРЫЕ Я ОПИСАЛ В ЭТОМ ОТВЕТЕ
    </script>
</body>
</html>
