<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–î–Ω–µ–≤–Ω–∏–∫ –ü–∏—Ç–∞–Ω–∏—è</title>
    <style>
        :root {
            --primary-color: #20c997;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #212529;
            --secondary-text-color: #6c757d;
            --progress-bg-color: #e9ecef;
            --goal-red-color: #e74c3c;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }

        .page { display: none; padding-bottom: 90px; }
        .page.active { display: block; }

        .header {
            background: var(--card-color); padding: 15px; padding-top: env(safe-area-inset-top);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex;
            justify-content: space-between; align-items: center;
        }
        .date-selector {
            display: flex; align-items: center; font-size: 1.1em; font-weight: 600;
        }
        .date-selector .arrow { font-size: 1.5em; color: var(--secondary-text-color); cursor: pointer; padding: 5px 10px; }
        .header-icon { font-size: 1.5em; cursor: pointer; color: var(--secondary-text-color); }

        .calorie-summary { background: var(--card-color); border-radius: 20px; padding: 20px; margin: 15px; text-align: center; }
        .calorie-circle-container { position: relative; width: 180px; height: 180px; margin: 15px auto; }
        .calorie-circle-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring-bg { stroke: var(--progress-bg-color); fill: none; stroke-width: 14; }
        .progress-ring-fg { stroke: var(--primary-color); fill: none; stroke-width: 14; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease-out; }
        .circle-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-text-remaining { font-size: 2.2em; font-weight: 700; }
        .circle-text-label { font-size: 0.9em; color: var(--secondary-text-color); }
        .calorie-details { display: flex; justify-content: space-between; margin-top: 10px; }
        .detail-item { flex: 1; text-align: center; }
        .detail-item p { margin: 0; font-size: 1.2em; font-weight: 600; }
        .detail-item span { font-size: 0.8em; color: var(--secondary-text-color); }
        .detail-item p.eaten { color: var(--goal-red-color); }
        .detail-item p.burned { color: #0d6efd; }

        .macros-summary { display: flex; justify-content: space-around; gap: 10px; padding: 0 15px; }
        .macro { flex: 1; background: var(--card-color); border-radius: 12px; padding: 12px; }
        .macro-header { display: flex; align-items: center; font-size: 0.8em; margin-bottom: 8px; color: var(--secondary-text-color); }
        .macro-header img { width: 16px; height: 16px; margin-right: 5px; }
        .macro-value { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; }
        .progress-bar { background-color: var(--progress-bg-color); height: 5px; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; border-radius: 3px; transition: width 0.5s; }
        #carbs-progress .progress-bar-fill { background-color: #fd7e14; }
        #protein-progress .progress-bar-fill { background-color: #dc3545; }
        #fat-progress .progress-bar-fill { background-color: #ffc107; }

        .meal-card {
            display: flex; align-items: center; background: var(--card-color);
            padding: 15px; border-radius: 16px; margin: 15px;
            box-shadow: 0 4px 15px rgba(100,100,100,0.06);
        }
        .meal-card .icon { font-size: 1.5em; margin-right: 15px; }
        .meal-card .details { flex-grow: 1; }
        .meal-card .details p { margin: 0; font-weight: 500; }
        .meal-card .details span { font-size: 0.85em; color: var(--secondary-text-color); }
        .meal-card .action-btn {
            width: 38px; height: 38px; border-radius: 50%;
            background-color: var(--primary-color); color: white;
            font-size: 1.8em; border: none; cursor: pointer; line-height: 38px; text-align: center;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around;
            background-color: var(--card-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            height: 60px; padding-bottom: env(safe-area-inset-bottom); z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: var(--secondary-text-color); cursor: pointer; padding-top: 10px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; }
        .nav-item div { font-size: 0.7em; }
        .fab {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 64px; height: 64px; background-color: var(--primary-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; color: white;
            font-size: 2.5em; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1001; border: 4px solid var(--background-color);
        }
        
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            flex-direction: column; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        .modal-header .close-btn { font-size: 2em; cursor: pointer; border: none; background: none; }
        .modal-content { padding: 0 15px; overflow-y: auto; flex-grow: 1; }
        
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ö–∞–ª–µ–Ω–¥–∞—Ä—è --- */
        #calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; font-size: 1.2em; font-weight: 600; }
        #calendar-grid, .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
        .weekdays div { font-size: 0.8em; color: var(--secondary-text-color); }
        #calendar-grid .day { padding: 10px 0; border-radius: 50%; cursor: pointer; position: relative; }
        #calendar-grid .day.other-month { color: #ccc; }
        #calendar-grid .day.today { font-weight: bold; background-color: #eee; }
        #calendar-grid .day.completed { border: 2px solid var(--goal-red-color); }
        #calendar-grid .day.selected { background-color: var(--primary-color); color: white; }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ --- */
        .stats-tabs { display: flex; background: #e9ecef; border-radius: 8px; padding: 4px; margin: 15px; }
        .stats-tabs .tab { flex: 1; text-align: center; padding: 8px; border-radius: 6px; cursor: pointer; }
        .stats-tabs .tab.active { background: var(--card-color); font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-card { background: var(--card-color); border-radius: 12px; padding: 15px; margin: 15px; }
        .bar-chart-container { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-bottom: 1px solid #eee; padding: 10px 0; }
        .bar-wrapper { flex: 1; text-align: center; }
        .bar { background-color: #ffc107; width: 60%; margin: 0 auto; border-top-left-radius: 4px; border-top-right-radius: 4px; transition: height 0.5s; }
        .bar-label { font-size: 0.7em; color: var(--secondary-text-color); margin-top: 4px; }
        .avg-meal-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .avg-meal-item { text-align: center; }
        .avg-meal-item .icon { font-size: 1.5em; }
        .avg-meal-item p { margin: 5px 0 0; font-weight: 600; }
        .avg-meal-item span { font-size: 0.8em; color: var(--secondary-text-color); }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ–¥—ã */
        input, select { width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 1em; box-sizing: border-box; background: #fff; }
        button.primary { background-color: var(--primary-color); color: white; padding: 15px; border: none; border-radius: 12px; cursor: pointer; width: 100%; font-size: 1.1em; font-weight: 600; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 10px; background: var(--primary-color); color: white; text-align: center; cursor: pointer; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        #search-results button { background-color: #f0f0f0; color: #333; margin-bottom: 5px; text-align: left; }
    </style>
</head>
<body>

    <!-- PAGE 1: –î–Ω–µ–≤–Ω–∏–∫ -->
    <div id="diaryPage" class="page active">
        <div class="header">
            <span class="header-icon" onclick="openCalendarModal()">üóìÔ∏è</span>
            <div class="date-selector">
                <span class="arrow" onclick="changeDate(-1)">&lt;</span>
                <span id="current-date"></span>
                <span class="arrow" onclick="changeDate(1)">&gt;</span>
            </div>
            <span class="header-icon" style="visibility: hidden;">üëë</span> <!-- Placeholder for symmetry -->
        </div>
        <div id="diary-content"></div>
    </div>
    
    <!-- PAGE 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statsPage" class="page">
        <div class="header" style="justify-content: center;">
            <div class="date-selector">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
        <div class="stats-tabs">
            <div class="tab active" onclick="renderStats(7)">7 –¥–Ω.</div>
            <div class="tab" onclick="renderStats(30)">30 –¥–Ω.</div>
            <div class="tab" onclick="renderStats(90)">90 –¥–Ω.</div>
        </div>
        <div id="stats-content"></div>
    </div>

    <!-- PAGE 3: –ë–æ–ª—å—à–µ/–ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settingsPage" class="page">
        <div class="header" style="justify-content: center;">
            <div class="date-selector">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
        <div style="padding: 15px;">
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">–¶–µ–ª–∏ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º –∏ –ë–ñ–£</p>
                <input type="number" id="goal-calories-input" placeholder="–¶–µ–ª—å –∫–∞–ª–æ—Ä–∏–π (–∫–∫–∞–ª)">
                <input type="number" id="goal-carbs-input" placeholder="–¶–µ–ª—å —É–≥–ª–µ–≤–æ–¥—ã (–≥)">
                <input type="number" id="goal-protein-input" placeholder="–¶–µ–ª—å –±–µ–ª–∫–∏ (–≥)">
                <input type="number" id="goal-fat-input" placeholder="–¶–µ–ª—å –∂–∏—Ä—ã (–≥)">
            </div>
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">API Edamam (–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)</p>
                <input type="text" id="edamam-id-input" placeholder="Edamam Application ID">
                <input type="text" id="edamam-key-input" placeholder="Edamam Application Key">
            </div>
            <div class="meal-card" style="flex-direction: column; align-items: normal;">
                <p style="font-weight: 500;">API Spoonacular (–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ —Ñ–æ—Ç–æ)</p>
                <input type="text" id="food-api-key-input" placeholder="Spoonacular API –∫–ª—é—á">
            </div>
            <button class="primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ FAB -->
    <div class="fab" onclick="openFoodModal(null)">+</div>
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('diaryPage')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M20 3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 17H4v-5h4v5zm6 0h-4v-5h4v5zm6 0h-4v-5h4v5zM8 10H4V5h4v5zm6 0h-4V5h4v5zm6 0h-4V5h4v5z"/></svg>
            <div>–î–Ω–µ–≤–Ω–∏–∫</div>
        </div>
        <div class="nav-item" onclick="showPage('statsPage')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M4 9h4v11H4zM10 9h4v11h-4zM16 9h4v11h-4z"/></svg>
            <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
        <div class="nav-item" onclick="showPage('settingsPage')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            <div>–ë–æ–ª—å—à–µ</div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –î–æ–±–∞–≤–ª–µ–Ω–∏—è –ï–¥—ã -->
    <div id="addFoodModal" class="modal">
        <div class="modal-header">
            <h2 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h2>
            <button class="close-btn" onclick="closeFoodModal()">&times;</button>
        </div>
        <div class="modal-content">
            <select id="meal-type-select">
                <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</option>
                <option value="lunch">–û–±–µ–¥</option>
                <option value="dinner">–£–∂–∏–Ω</option>
                <option value="snacks">–ü–µ—Ä–µ–∫—É—Å</option>
            </select>
            <hr>
            <div class="file-upload-wrapper">
                <span>üì∑ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –µ–¥—É –ø–æ —Ñ–æ—Ç–æ</span>
                <input type="file" id="photo-upload" accept="image/*" onchange="recognizeFoodByImage(this)">
            </div>
            <p style="text-align:center; color: var(--secondary-text-color); margin: 15px;">- –∏–ª–∏ -</p>
            <input type="search" id="search-food-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            <button class="primary" onclick="searchFoodByText()">–ù–∞–π—Ç–∏</button>
            <div id="search-results" style="margin: 15px 0;"></div>
            <hr>
            <input type="text" id="manual-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="number" id="manual-calories" placeholder="–ö–∞–ª–æ—Ä–∏–∏">
            <input type="number" id="manual-protein" placeholder="–ë–µ–ª–∫–∏ (–≥)">
            <input type="number" id="manual-fat" placeholder="–ñ–∏—Ä—ã (–≥)">
            <input type="number" id="manual-carbs" placeholder="–£–≥–ª–µ–≤–æ–¥—ã (–≥)">
            <button class="primary" onclick="addFoodEntry()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ö–∞–ª–µ–Ω–¥–∞—Ä—è -->
    <div id="calendarModal" class="modal">
        <div class="modal-header">
            <h2 id="calendar-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
            <button class="close-btn" onclick="closeCalendarModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div id="calendar-header">
                <span class="arrow" onclick="changeCalendarMonth(-1)">&lt;</span>
                <span id="month-year-display"></span>
                <span class="arrow" onclick="changeCalendarMonth(1)">&gt;</span>
            </div>
            <div class="weekdays">
                <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>
    
    <script>
        let selectedDate = new Date();
        let currentMealType = '';
        let calendarDate = new Date();

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            showPage('diaryPage');
            changeDate(0);
        });

        // --- –û–ë–©–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const activeNavItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick') === `showPage('${pageId}')`);
            if(activeNavItem) activeNavItem.classList.add('active');
            
            if (pageId === 'statsPage') {
                renderStats(7); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ 7 –¥–Ω–µ–π
                document.querySelector('.stats-tabs .tab').classList.add('active');
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ì–õ–ê–í–ù–û–ì–û –≠–ö–†–ê–ù–ê (–î–ù–ï–í–ù–ò–ö) ---
        function changeDate(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            const today = new Date();
            const isToday = selectedDate.toDateString() === today.toDateString();
            document.getElementById('current-date').textContent = isToday ? '–°–µ–≥–æ–¥–Ω—è' : selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            renderDiary();
        }

        function renderDiary() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            const content = document.getElementById('diary-content');
            
            content.innerHTML = `
                <div class="calorie-summary" id="calorie-summary"></div>
                <div class="macros-summary" id="macros-summary"></div>
                ${createMealCard('breakfast', '–ó–∞–≤—Ç—Ä–∞–∫', 'üçû', data.food || [])}
                ${createMealCard('lunch', '–û–±–µ–¥', 'üç≤', data.food || [])}
                ${createMealCard('dinner', '–£–∂–∏–Ω', 'üåô', data.food || [])}
                ${createMealCard('snacks', '–ü–µ—Ä–µ–∫—É—Å', 'üçè', data.food || [])}
                <div class="meal-card" onclick="addActivity()">
                    <div class="icon" style="background: #fff5e6">üî•</div>
                    <div class="details"><p>–°–æ–∂–∂–µ–Ω–æ –∫–∞–ª–æ—Ä–∏–π</p><span>${data.activity || 0} –∫–∫–∞–ª</span></div>
                </div>
            `;
            updateSummary();
        }

        function updateSummary() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            const settings = loadSettings();
            
            const food = data.food || [];
            const eaten = food.reduce((sum, item) => sum + (item.calories || 0), 0);
            const burned = data.activity || 0;
            const remaining = settings.goalCalories - eaten + burned;

            const totalCarbs = food.reduce((sum, item) => sum + (item.carbs || 0), 0);
            const totalProtein = food.reduce((sum, item) => sum + (item.protein || 0), 0);
            const totalFat = food.reduce((sum, item) => sum + (item.fat || 0), 0);

            const summaryContainer = document.getElementById('calorie-summary');
            const progress = eaten / settings.goalCalories;
            const radius = 83;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.min(progress, 1) * circumference);

            summaryContainer.innerHTML = `
                <div class="calorie-circle-container">
                    <svg class="calorie-circle-svg"><circle class="progress-ring-bg" cx="90" cy="90" r="${radius}"></circle><circle class="progress-ring-fg" cx="90" cy="90" r="${radius}" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle></svg>
                    <div class="circle-text"><div class="circle-text-remaining">${remaining.toFixed(0)}</div><div class="circle-text-label">–û—Å—Ç–∞–ª–æ—Å—å –∫–∫–∞–ª</div></div>
                </div>
                <div class="calorie-details">
                    <div class="detail-item"><p class="eaten">${eaten.toFixed(0)}</p><span>–°—ä–µ–¥–µ–Ω–æ</span></div>
                    <div class="detail-item"><p class="burned">${burned.toFixed(0)}</p><span>–°–æ–∂–∂–µ–Ω–æ</span></div>
                </div>`;
            
            const macrosContainer = document.getElementById('macros-summary');
            macrosContainer.innerHTML = `
                <div class="macro" id="carbs-progress">
                    <div class="macro-header"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAARlJREFUaEPtmdENwyAMRb830E1gE5gENoFN0I3QTWAbwAbSCbQTD4mIdoBEfPgiUvj7k/g5pxOiIAgCgkBXa2tB3t4u4Z1gDhPBDsC93Yjz2P0hCCuA3w+QZ6/dD4KxBdgN93Yi3t4uYQ5ngK1atWq12g/w4wCS2n4IxhbgN9zbifL0VjCncwBFpaIggjEB+PPgiLQNwjKEKV0AU2kphGFMwH4+OKLtDMIyZgAVKWgExhDg14Mj2jYIy1gBFJSCEgI8/QdoxV+LYO93gJBIKSLg14Mj2jYIy5gBVJSCEgI8/QdoxV+L4O13AElJISLg14Mj2jYIy5gBVJSCEgJ8+g/QqvxZBO/eA0hKCSHg94MjeT8IxqgAXG53eXj7/0G0a9WqVKv9Ad/eD4LgG4VpAAAAAElFTkSuQmCC"> –£–≥–ª–µ–≤–æ–¥—ã</div>
                    <div class="macro-value">${totalCarbs.toFixed(0)} –≥</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalCarbs / settings.goalCarbs) * 100)}%;"></div></div>
                </div>
                <div class="macro" id="protein-progress">
                    <div class="macro-header"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAhtJREFUaEPtmd1xwyAMhV83gG4AGzACNkA3gA1gA5gI3AA2gA3gBtAJ3BO6lEhybOkokqT4A5V8sM/97L23l2SiWEQixUvSCbRdXV3h7e2t4l8A/2r1q1qt9n8C/J5Wq/11sVjM5fP5lHqYz+dzSaPRyGaz2YF2vS+V/wSAs2w2M4VCoUjW2tq6FjsAU/3+/q5er88kK5VK2UDAXk0mk20mk7kE8D6VSiXz+fwZgA/b9/05gN2pXq/PiqL4GoDFYpEHDvCtwu/7m18A/wT+P8PzM4BWq9WEgP1oOp1uy+XyEoB3y+Xy7Xg8PoM5wKzdbvdjY2MDALba2tpaFBzArEqlkkql0iKAr5VK5a1yuZxG7Y5Go62lpaUrgG8ul8v/sVi8B/B+sVj8LpPJ/BvAR+Px+O1SqfQWwGaz+QngfZVKpa3dbi9Ab29vv7i6unoDsFar1TpwPp/P83q9viN93t/fXwTgj+PxeL1er4P9wGAw+ADgXQzDBwA+3n/jANs4jg8YhuHDwWBw1d/f/yIAj8fjwbIsP2EYvguwH6wXAGzLsvxUKvUJ4C2VSv1ijUbTgwMctizLD/o/wP/55z9kGO5tZ2fnUigUb3G/3/8YwN+FQqEnnU7/BGDDcDsA88FisXgej+cWwGq13pVK5fE/wJtWq/3p7u7+AQBfK5XKY7FY/C9Wq9UqEIlEWgM0o2VbAAAAAElFTkSuQmCC"> –ë–µ–ª–∫–∏</div>
                    <div class="macro-value">${totalProtein.toFixed(0)} –≥</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalProtein / settings.goalProtein) * 100)}%;"></div></div>
                </div>
                <div class="macro" id="fat-progress">
                    <div class="macro-header"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAjBJREFUaEPtmF1RAzEMhV83AAbACLABMhAyAWQCkAEyAQkQATJABkKC3lPZsrw09u7u5o8qOVrS7vN6/Z4klxTGRFh8UbrA7e3tla6urlb9JcBHtbW1ZrPZCb5qtVqvVqv1C+AbzGazJ4vF4gLAgYODg4ODg58A/q7V6r31ej3A9/1+v/9/v9/f19fX4ziO4wWAkydPntzc3PwqAHe3t7c3Vqv1WQDf1Wr1sYODg8/j8fgU4Cd1dXWFqqq+AnherVa/u7q6EgCslpaW7sFgMAWwWCwW/2EYvgLwUqvVHwwG86qqvjEA27quWZZlWQD/XqvV/gngy+Px+JzP5/8L4Jtms/lms/kgQLqu65IkPQH4UKvVHsMw3NXV1RUIBHgI4E3T9J+maf/rDODfpmk/4zi+BfD96urqO51O5wLAzM/P7w8Gg4MAnq7rfg8A/r979+5bKpX6COBppVL59vj4+CeAv2EYvufz+X8A3jUajfPxeHwKYDAYfNPS0nISwJ9MJvNtOp1uAVim6ePxeHwDsNfr9W+m0+kfgW9MJvMfrVYrAEiSpMvlch/43t/fXz98+PAWwPv9/f2lUqkbAB4+fPj27du3bwBeunTp9Z07d+7dunXr/wLe3d/fPzw4OPglAJeXl5evXr26DsCVl5dXV1dXN2EYvhegtbU13d3dXQGq1+sfHR0dXQFYrVZ/ODk5GQAWjUbT/X6/PyB4/AZ772J3y2g0mgAAAABJRU5ErkJggg=="> –ñ–∏—Ä—ã</div>
                    <div class="macro-value">${totalFat.toFixed(0)} –≥</div>
                    <div class="progress-bar"><div class="progress-bar-fill" style="width: ${Math.min(100, (totalFat / settings.goalFat) * 100)}%;"></div></div>
                </div>
            `;
        }

        function createMealCard(type, name, icon, foodList) {
            const mealItems = foodList.filter(f => f.mealType === type);
            const totalCalories = mealItems.reduce((sum, item) => sum + item.calories, 0);
            let foodHtml = mealItems.map(item => `<div onclick="event.stopPropagation(); removeFood('${item.id}')">${item.name} - ${item.calories.toFixed(0)} –∫–∫–∞–ª</div>`).join('');
            
            return `
            <div class="meal-card">
                <div class="icon">${icon}</div>
                <div class="details"><p>${name}</p><span>${totalCalories.toFixed(0)} –∫–∫–∞–ª</span><div style="font-size: 0.8em; margin-top: 5px; color: #555;">${foodHtml || ''}</div></div>
                <button class="action-btn" onclick="openFoodModal('${type}')">+</button>
            </div>`;
        }
        
        // --- –õ–û–ì–ò–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
        function renderStats(days) {
            document.querySelectorAll('.stats-tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const statsContent = document.getElementById('stats-content');
            const data = getStatsData(days);

            // Bar Chart
            const maxCalories = Math.max(...data.dailyCalories.map(d => d.calories), loadSettings().goalCalories);
            const chartHtml = data.dailyCalories.map(d => `
                <div class="bar-wrapper">
                    <div class="bar" style="height: ${ (d.calories / maxCalories) * 100 }%;"></div>
                    <div class="bar-label">${d.label}</div>
                </div>
            `).join('');

            // Averages
            const avgMeals = {
                breakfast: { count: 0, cals: 0 }, lunch: { count: 0, cals: 0 },
                dinner: { count: 0, cals: 0 }, snacks: { count: 0, cals: 0 }
            };
            data.allFood.forEach(item => {
                if (avgMeals[item.mealType]) {
                    avgMeals[item.mealType].count++;
                    avgMeals[item.mealType].cals += item.calories;
                }
            });

            statsContent.innerHTML = `
                <div class="stats-card">
                    <h3>–ö–∞–ª–æ—Ä–∏–∏</h3>
                    <p style="font-size: 0.9em; color: var(--secondary-text-color);">–°—É–º–º–∞ ${data.totalCalories.toFixed(0)} –∫–∫–∞–ª</p>
                    <div class="bar-chart-container">${chartHtml}</div>
                </div>
                <div class="stats-card">
                    <h3>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏</h3>
                    <div class="avg-meal-summary">
                        ${Object.keys(avgMeals).map(type => `
                            <div class="avg-meal-item">
                                <div class="icon">${{breakfast:'üçû', lunch:'üç≤', dinner:'üåô', snacks:'üçè'}[type]}</div>
                                <p>${(avgMeals[type].cals / (avgMeals[type].count || 1)).toFixed(0)} –∫–∫–∞–ª</p>
                                <span>${{breakfast:'–ó–∞–≤—Ç—Ä–∞–∫', lunch:'–û–±–µ–¥', dinner:'–£–∂–∏–Ω', snacks:'–ü–µ—Ä–µ–∫—É—Å'}[type]} ${avgMeals[type].count}x</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getStatsData(days) {
            let allFood = [];
            let dailyCalories = [];
            const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const data = loadDataForDate(dateKey);
                if (data.food) allFood.push(...data.food);
                dailyCalories.push({
                    calories: (data.food || []).reduce((sum, item) => sum + item.calories, 0),
                    label: dayNames[date.getDay()]
                });
            }
            dailyCalories.reverse();
            
            return {
                allFood,
                dailyCalories,
                totalCalories: allFood.reduce((sum, item) => sum + item.calories, 0)
            };
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø ---
        function openCalendarModal() { document.getElementById('calendarModal').style.display = 'flex'; renderCalendar(); }
        function closeCalendarModal() { document.getElementById('calendarModal').style.display = 'none'; }
        
        function changeCalendarMonth(monthOffset) {
            calendarDate.setMonth(calendarDate.getMonth() + monthOffset);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const display = document.getElementById('month-year-display');
            grid.innerHTML = '';
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            display.textContent = calendarDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;

            for (let i = 0; i < dayOffset; i++) { grid.innerHTML += `<div></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                dayEl.textContent = day;
                
                const dateKey = new Date(year, month, day).toISOString().split('T')[0];
                const data = loadDataForDate(dateKey);
                const settings = loadSettings();
                const eaten = (data.food || []).reduce((sum, item) => sum + item.calories, 0);

                if (eaten >= settings.goalCalories) {
                    dayEl.classList.add('completed');
                }
                grid.appendChild(dayEl);
            }
        }

        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ï–ô –ò API ---
        function loadDataForDate(dateKey) { return JSON.parse(localStorage.getItem(dateKey) || '{}'); }
        function saveDataForDate(dateKey, data) { localStorage.setItem(dateKey, JSON.stringify(data)); }
        
        function saveSettings() {
            const settings = {
                goalCalories: document.getElementById('goal-calories-input').value,
                goalCarbs: document.getElementById('goal-carbs-input').value,
                goalProtein: document.getElementById('goal-protein-input').value,
                goalFat: document.getElementById('goal-fat-input').value,
                edamamId: document.getElementById('edamam-id-input').value,
                edamamKey: document.getElementById('edamam-key-input').value,
                foodApiKey: document.getElementById('food-api-key-input').value
            };
            localStorage.setItem('userSettings', JSON.stringify(settings));
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            renderDiary();
            showPage('diaryPage');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            const defaults = { goalCalories: 2000, goalCarbs: 250, goalProtein: 150, goalFat: 70, edamamId: '', edamamKey: '', foodApiKey: '' };
            const finalSettings = { ...defaults, ...settings };

            document.getElementById('goal-calories-input').value = finalSettings.goalCalories;
            document.getElementById('goal-carbs-input').value = finalSettings.goalCarbs;
            document.getElementById('goal-protein-input').value = finalSettings.goalProtein;
            document.getElementById('goal-fat-input').value = finalSettings.goalFat;
            document.getElementById('edamam-id-input').value = finalSettings.edamamId;
            document.getElementById('edamam-key-input').value = finalSettings.edamamKey;
            document.getElementById('food-api-key-input').value = finalSettings.foodApiKey;
            
            return finalSettings;
        }

        function openFoodModal(type) {
            if (type) {
                document.getElementById('meal-type-select').value = type;
            }
            document.getElementById('addFoodModal').style.display = 'flex';
        }
        function closeFoodModal() { document.getElementById('addFoodModal').style.display = 'none'; }
        
        async function translateText(text) {
            if (!text || !/[a-zA-Z]/.test(text)) return text;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ru`);
                const data = await response.json();
                return data.responseData?.translatedText || text;
            } catch (error) { return text; }
        }
        
        async function searchFoodByText() {
            const query = document.getElementById('search-food-input').value;
            const settings = loadSettings();
            if (!settings.edamamId || !settings.edamamKey) { alert('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á–∏ Edamam –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö'); return; }
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '–ü–æ–∏—Å–∫...';
            const url = `https://api.edamam.com/api/food-database/v2/parser?app_id=${settings.edamamId}&app_key=${settings.edamamKey}&ingr=${encodeURIComponent(query)}&nutrition-type=logging`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                resultsDiv.innerHTML = '';
                for (const item of data.hints.slice(0, 5)) {
                    const food = item.food;
                    const nutrients = food.nutrients;
                    const translatedName = await translateText(food.label);
                    const foodData = { name: translatedName, calories: nutrients.ENERC_KCAL || 0, protein: nutrients.PROCNT || 0, fat: nutrients.FAT || 0, carbs: nutrients.CHOCDF || 0 };
                    resultsDiv.innerHTML += `<button class="primary" onclick='selectFood(${JSON.stringify(foodData)})'>${translatedName} (${(nutrients.ENERC_KCAL || 0).toFixed(0)} –∫–∫–∞–ª)</button>`;
                }
            } catch (error) { resultsDiv.innerHTML = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞.'; }
        }

        async function recognizeFoodByImage(input) {
            const settings = loadSettings();
            if (!settings.foodApiKey) { alert('API –∫–ª—é—á –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ —Ñ–æ—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.'); return; }
            if (!input.files[0]) return;

            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = 'https://api.spoonacular.com/food/images/analyze';
            
            document.getElementById('search-results').innerHTML = '–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ...';
            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const response = await fetch(`${proxyUrl}${targetUrl}?apiKey=${settings.foodApiKey}`, { method: 'POST', body: formData });
                if (!response.ok) {
                   const errorData = await response.json();
                   throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}. ${errorData.message || ''}`);
                }
                const data = await response.json();
                if (data.category && data.nutrition && data.nutrition.calories) {
                    const translatedName = await translateText(data.category.name);
                    const foodData = { name: translatedName, calories: data.nutrition.calories.value, protein: data.nutrition.protein.value, fat: data.nutrition.fat.value, carbs: data.nutrition.carbs.value };
                    selectFood(foodData);
                    document.getElementById('search-results').innerHTML = `–ù–∞–π–¥–µ–Ω–æ: ${translatedName}!`;
                } else { document.getElementById('search-results').innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –µ–¥—É –Ω–∞ —Ñ–æ—Ç–æ.'; }
            } catch (error) {
                document.getElementById('search-results').innerHTML = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`;
            } finally { input.value = ''; }
        }

        function selectFood(data) {
            document.getElementById('manual-name').value = data.name;
            document.getElementById('manual-calories').value = (data.calories || 0).toFixed(0);
            document.getElementById('manual-protein').value = (data.protein || 0).toFixed(1);
            document.getElementById('manual-fat').value = (data.fat || 0).toFixed(1);
            document.getElementById('manual-carbs').value = (data.carbs || 0).toFixed(1);
            document.getElementById('search-results').innerHTML = '';
        }
        
        function addFoodEntry() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            if (!data.food) data.food = [];
            const newFood = {
                id: 'food_' + Date.now(),
                mealType: document.getElementById('meal-type-select').value,
                name: document.getElementById('manual-name').value,
                calories: parseFloat(document.getElementById('manual-calories').value) || 0,
                protein: parseFloat(document.getElementById('manual-protein').value) || 0,
                fat: parseFloat(document.getElementById('manual-fat').value) || 0,
                carbs: parseFloat(document.getElementById('manual-carbs').value) || 0,
            };
            data.food.push(newFood);
            saveDataForDate(dateKey, data);
            renderDiary();
            closeFoodModal();
        }
        
        function removeFood(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
            const dateKey = selectedDate.toISOString().split('T')[0];
            const data = loadDataForDate(dateKey);
            data.food = data.food.filter(f => f.id !== id);
            saveDataForDate(dateKey, data);
            renderDiary();
        }
        
        function addActivity() {
            const calories = parseInt(prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∂–∂–µ–Ω–Ω—ã—Ö –∫–∞–ª–æ—Ä–∏–π:'));
            if (calories && !isNaN(calories)) {
                const dateKey = selectedDate.toISOString().split('T')[0];
                const data = loadDataForDate(dateKey);
                data.activity = (data.activity || 0) + calories;
                saveDataForDate(dateKey, data);
                renderDiary();
            }
        }
    </script>
</body>
</html>
